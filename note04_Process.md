【Docker】Amazon Linux のコンテナ（AWS公式）を使って環境構築したら、EC2 デプロイのアプリは幸せになれるんじゃ無いかと思ったが、見事に頓挫した
____________________________

こんな環境で開発していました。


## 【 環境 】
ローカルの開発では Docker コンテナを使う。  
Docker composer を使い、PHP・Node.js・MySQL・Nginx・Redis が動いている。  
フレームワークは Laravel と Vue.js。  

Webアプリケーションは EC2 にデプロイ。  
EC2 インスタンス内で、Laravel と Vue.js が動くようにする。  

EC2 は２台用意し、ロードバランサで負荷を分散。  

その他の AWS のリソースは、VPC・Route 53・RDS・ElastiCache といったサービスを使用した、ごく普通の構成。  

本番環境・ステージング環境・開発環境と、同環境を３つ用意。  

## EC2 に実施する内容
EC2 には PHPおよび各種PHPモジュール、Composer でインストールできないモジュールについては個別にインストール。  
あとは Node.js や Nginx、git や AWS CLI といった、実行環境を用意するために必要なツールを入れていく。  

EC2 を１つ１つにアクセスして手作業でやるのが面倒なので、シェルスクリプトを用意して、コマンド一発で環境が整うようにしたい。  

当初は Ansible で構成管理をしてみようかと思ったのですが、想像以上にツラかったので、シェルスクリプトに落ち着きました。  

その時の記録がこちら。  
[Ansible って結構ツラいんじゃないかと思った話](https://kaki-note-02.netlify.app/2022/04/19/)  

## Amazon Linux の公式 Docker　を土台に、スクリプトを用意してみる
こういった作業は、一回で上手く行く事の方が珍しく、何度かトライアンドエラーを繰り返してようやく完成する、といったケースが圧倒的多数です。  
というか自分はそのパターンしか経験した事がありません。  

実験用の EC2 インスタンスを作成し、トライアンドエラーを繰り返しながらスクリプトを作成し、完成したら破棄、というステップでも出来るのですが、インスタンスを起動して色々実験して上手くいかない部分が出てくると、ハマッた時間の分だけ課金されるのが嫌だったので、実験用のスクリプトはローカルに用意できないかと考えてみました。  

すると、こんなのを見つけました。  
https://hub.docker.com/_/amazonlinux  

何と、AWS 公式の Amazon Linux イメージ！  

docker-compose.yml をこんな感じで書けば、Amazon Linux が起動してくれるという、夢のような代物。  
```yaml
services:
  amazonlinux:
    image: amazonlinux:2
```

PHP のコンテナは php:8.0-fpm、Node.js のコンテナは node:16-slim と、どちらも Debian 系ですが、Amazon Linux は RedHat系です。  

ディストリが異なるため、環境構築の方法が異なり、その差で余計なハマりポイントや上手くいかない部分に遭遇するのは、よくあるのではないかと思います。  

が、公式が Amazon Linux のコンテナイメージを配布しているのであれば話は別だ。  
php:8.0-fpm や Node.js、および nginx のコンテナを用意せず、Amazon Linux のコンテナに全部ブッ込む。  
開発環境用に作成したスクリプトは、そのまま AWS環境にも適用できるので、環境の差異による予想外のエラーは完全回避可能！  

おお！これはきっと幸せな未来が見えるんじゃないか！  
こんな幸せロードが見えてるのに、何で AWS は Amazon Linux の公式イメージを配布している事をもっとアピールしてくれないんだよ！もう全部コンテナで済ませろって事なのか！？　いや、コンテナはコンテナでつらみがあるし、まだまだ EC2 の出番は多いのに！  
と思いながら進めてみるものの、**ものの見事に失敗し、最終的には頓挫しました。**  

以下、失敗して諦めるまでの記録です。  

## プロセス







## 1コンテナ複数プロセスはやめておいた方が良い話
https://qiita.com/kazurego7/items/57f5fb80b4783b7633a1


コンテナ プロセス




## おまけ
この事を知人に話してみました。  

AWS 公式の Amazon Linux コンテナイメージを配布しているという事を話した時点では彼もテンションが上がり、「もう、開発環境は全部これ使えばいいじゃないですか！」と興奮気味に話を聞いてくれたものの、結末を話したら、「え？じゃあこのコンテナ、何に使うんですか？」といった反応でした。  

**俺もそう思う。**  
何に使うんだ。このコンテナイメージ。  

変なトラップ踏んで、無駄に時間溶かしただけだった。




